"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var S=require("@walletconnect/core"),O=require("@walletconnect/logger"),G=require("@walletconnect/types"),i=require("@walletconnect/utils"),$=require("events"),p=require("@walletconnect/time"),h=require("@walletconnect/jsonrpc-utils");function H(d){return d&&typeof d=="object"&&"default"in d?d:{default:d}}var B=H($);const C="wc",A=2,L="client",q=`${C}@${A}:${L}:`,f={name:L,logger:"error",controller:!1,relayUrl:"wss://relay.walletconnect.com"},W={session_proposal:"session_proposal",session_update:"session_update",session_extend:"session_extend",session_ping:"session_ping",session_delete:"session_delete",session_expire:"session_expire",session_request:"session_request",session_request_sent:"session_request_sent",session_event:"session_event",proposal_expire:"proposal_expire"},Z={database:":memory:"},U="WALLETCONNECT_DEEPLINK_CHOICE",ee={created:"history_created",updated:"history_updated",deleted:"history_deleted",sync:"history_sync"},se="history",te="0.3",Y="proposal",ie=p.THIRTY_DAYS,k="Proposal expired",J="session",P=p.SEVEN_DAYS,K="engine",R={wc_sessionPropose:{req:{ttl:p.FIVE_MINUTES,prompt:!0,tag:1100},res:{ttl:p.FIVE_MINUTES,prompt:!1,tag:1101}},wc_sessionSettle:{req:{ttl:p.FIVE_MINUTES,prompt:!1,tag:1102},res:{ttl:p.FIVE_MINUTES,prompt:!1,tag:1103}},wc_sessionUpdate:{req:{ttl:p.ONE_DAY,prompt:!1,tag:1104},res:{ttl:p.ONE_DAY,prompt:!1,tag:1105}},wc_sessionExtend:{req:{ttl:p.ONE_DAY,prompt:!1,tag:1106},res:{ttl:p.ONE_DAY,prompt:!1,tag:1107}},wc_sessionRequest:{req:{ttl:p.FIVE_MINUTES,prompt:!0,tag:1108},res:{ttl:p.FIVE_MINUTES,prompt:!1,tag:1109}},wc_sessionEvent:{req:{ttl:p.FIVE_MINUTES,prompt:!0,tag:1110},res:{ttl:p.FIVE_MINUTES,prompt:!1,tag:1111}},wc_sessionDelete:{req:{ttl:p.ONE_DAY,prompt:!1,tag:1112},res:{ttl:p.ONE_DAY,prompt:!1,tag:1113}},wc_sessionPing:{req:{ttl:p.THIRTY_SECONDS,prompt:!1,tag:1114},res:{ttl:p.THIRTY_SECONDS,prompt:!1,tag:1115}}},V={min:p.FIVE_MINUTES,max:p.SEVEN_DAYS},N={idle:"idle",active:"active"},Q="request",X=["wc_sessionPropose","wc_sessionRequest","wc_authRequest"];var re=Object.defineProperty,ne=Object.defineProperties,oe=Object.getOwnPropertyDescriptors,j=Object.getOwnPropertySymbols,ae=Object.prototype.hasOwnProperty,ce=Object.prototype.propertyIsEnumerable,z=(d,n,e)=>n in d?re(d,n,{enumerable:!0,configurable:!0,writable:!0,value:e}):d[n]=e,I=(d,n)=>{for(var e in n||(n={}))ae.call(n,e)&&z(d,e,n[e]);if(j)for(var e of j(n))ce.call(n,e)&&z(d,e,n[e]);return d},M=(d,n)=>ne(d,oe(n));class le extends G.IEngine{constructor(n){super(n),this.name=K,this.events=new B.default,this.initialized=!1,this.ignoredPayloadTypes=[i.TYPE_1],this.requestQueue={state:N.idle,requests:[]},this.requestQueueDelay=p.ONE_SECOND,this.init=async()=>{this.initialized||(await this.cleanup(),this.registerRelayerEvents(),this.registerExpirerEvents(),this.client.core.pairing.register({methods:Object.keys(R)}),this.initialized=!0,setTimeout(()=>{this.requestQueue.requests=this.getPendingSessionRequests(),this.processRequestQueue()},p.toMiliseconds(this.requestQueueDelay)))},this.connect=async e=>{this.isInitialized();const s=M(I({},e),{requiredNamespaces:e.requiredNamespaces||{},optionalNamespaces:e.optionalNamespaces||{}});await this.isValidConnect(s);const{pairingTopic:t,requiredNamespaces:r,optionalNamespaces:o,sessionProperties:a,relays:c}=s;let l=t,g,w=!1;if(l&&(w=this.client.core.pairing.pairings.get(l).active),!l||!w){const{topic:_,uri:m}=await this.client.core.pairing.create();l=_,g=m}const u=await this.client.core.crypto.generateKeyPair(),y=I({requiredNamespaces:r,optionalNamespaces:o,relays:c??[{protocol:S.RELAYER_DEFAULT_PROTOCOL}],proposer:{publicKey:u,metadata:this.client.metadata}},a&&{sessionProperties:a}),{reject:E,resolve:v,done:x}=i.createDelayedPromise(p.FIVE_MINUTES,k);if(this.events.once(i.engineEvent("session_connect"),async({error:_,session:m})=>{if(_)E(_);else if(m){m.self.publicKey=u;const b=M(I({},m),{requiredNamespaces:m.requiredNamespaces,optionalNamespaces:m.optionalNamespaces});await this.client.session.set(m.topic,b),await 